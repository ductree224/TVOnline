@using TVOnline.ViewModels.UserProfile;
@model EditUserProfileViewModel;

@{
    ViewData["Title"] = "Chỉnh sửa thông tin";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var hasPassword = ViewBag.HasPassword;
    var cvDetail = ViewBag.CvDetail as ApplicationCvDetailViewModel;
}

<section class="profile-section py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                @if (!string.IsNullOrEmpty(Context.Request.Query["error"]))
                {
                    <div class="alert alert-danger alert-dismissible fade show rounded-4 mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @Context.Request.Query["error"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(Context.Request.Query["success"]))
                {
                    <div class="alert alert-success alert-dismissible fade show rounded-4 mb-4" role="alert">
                        <i class="bi bi-check-circle-fill me-2"></i> @Context.Request.Query["success"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(ViewBag.CvDetailError))
                {
                    <div class="alert alert-danger alert-dismissible fade show rounded-4 mb-4" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> @ViewBag.CvDetailError
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden fade-in-up">
                    <div class="card-header bg-primary bg-gradient py-3">
                        <h3 class="text-white mb-0">
                            <i class="bi bi-person-gear me-2"></i>Thông tin cá nhân
                        </h3>
                    </div>
                    <div class="card-body p-4">
                        <ul class="nav nav-tabs profile-tabs mb-4" id="profileTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active d-flex align-items-center" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                    <i class="bi bi-person-fill me-2"></i> Thông tin cá nhân
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link d-flex align-items-center" id="cv-tab" data-bs-toggle="tab" data-bs-target="#cv" type="button" role="tab">
                                    <i class="bi bi-file-earmark-person-fill me-2"></i> Thông tin bổ sung
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link d-flex align-items-center" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab">
                                    <i class="bi bi-key-fill me-2"></i> @(hasPassword ? "Đổi mật khẩu" : "Tạo mật khẩu")
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="profileTabsContent">
                            <!-- Tab Thông tin cá nhân -->
                            <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
                                <div class="user-avatar text-center mb-4">
                                    <div class="position-relative d-inline-block">
                                        <img src="https://via.placeholder.com/150" alt="Avatar" class="rounded-circle img-thumbnail" width="150" height="150">
                                        <button type="button" class="btn btn-sm btn-primary rounded-circle position-absolute bottom-0 end-0">
                                            <i class="bi bi-camera-fill"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <form asp-action="UpdateProfile" method="post" enctype="multipart/form-data">
                                    <input type="hidden" id="Id" asp-for="Id" />
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <div class="form-floating mb-3">
                                                <input type="text" id="floatingName" class="form-control" asp-for="Name" placeholder="Họ và tên" required>
                                                <label asp-for="Name" for="floatingName">Họ và tên</label>
                                            </div>
                                            <div class="form-floating mb-3">
                                                <input type="email" id="floatingEmail" class="form-control" asp-for="Email" placeholder="Email" readonly>
                                                <label asp-for="Email" for="floatingEmail">Email</label>
                                            </div>
                                            <div class="form-floating mb-3">
                                                <input type="text" id="floatingCity" class="form-control" asp-for="City" placeholder="Thành phố">
                                                <label asp-for="City" for="floatingCity">Thành phố</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-floating mb-3">
                                                <input type="tel" id="floatingPhone" class="form-control" asp-for="PhoneNumber" placeholder="Số điện thoại">
                                                <label asp-for="PhoneNumber" for="floatingPhone">Số điện thoại</label>
                                            </div>
                                            <div class="form-floating mb-3">
                                                <input type="date" id="floatingDob" class="form-control" asp-for="Dob" placeholder="Ngày sinh">
                                                <label asp-for="Dob" for="floatingDob">Ngày sinh</label>
                                            </div>
                                            <div class="form-floating mb-3">
                                                <input type="text" id="floatingJob" class="form-control" asp-for="Job" placeholder="Nghề nghiệp">
                                                <label asp-for="Job" for="floatingJob">Nghề nghiệp</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-primary px-5 py-2">
                                            <i class="bi bi-save me-2"></i> Lưu thông tin
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Tab Thông tin bổ sung -->
                            <div class="tab-pane fade" id="cv" role="tabpanel" aria-labelledby="cv-tab">
                                <div class="alert alert-info rounded-3 mb-4">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i class="bi bi-info-circle-fill fs-4"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h5 class="alert-heading">Thông tin bổ sung của bạn</h5>
                                            <p class="mb-0">Thông tin này sẽ được hiển thị cho nhà tuyển dụng khi bạn ứng tuyển vào vị trí công việc. Hãy cập nhật đầy đủ để tăng cơ hội được tuyển dụng.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <form asp-action="UpdateCvDetail" method="post">
                                    <input type="hidden" name="UserId" value="@cvDetail.UserId" />
                                    
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0"><i class="bi bi-mortarboard-fill me-2"></i>Học vấn</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="School" name="School" class="form-control" value="@cvDetail.School" placeholder="Trường học">
                                                        <label for="School">Trường học</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="Major" name="Major" class="form-control" value="@cvDetail.Major" placeholder="Chuyên ngành">
                                                        <label for="Major">Chuyên ngành</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="Degree" name="Degree" class="form-control" value="@cvDetail.Degree" placeholder="Bằng cấp">
                                                        <label for="Degree">Bằng cấp</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="number" id="GraduationYear" name="GraduationYear" class="form-control" value="@cvDetail.GraduationYear" placeholder="Năm tốt nghiệp" min="1950" max="2050">
                                                        <label for="GraduationYear">Năm tốt nghiệp</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating mb-3">
                                                        <textarea id="Education" name="Education" class="form-control" placeholder="Mô tả học vấn" style="height: 100px">@cvDetail.Education</textarea>
                                                        <label for="Education">Mô tả học vấn</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0"><i class="bi bi-briefcase-fill me-2"></i>Kinh nghiệm làm việc</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="LastCompany" name="LastCompany" class="form-control" value="@cvDetail.LastCompany" placeholder="Công ty gần nhất">
                                                        <label for="LastCompany">Công ty gần nhất</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="LastPosition" name="LastPosition" class="form-control" value="@cvDetail.LastPosition" placeholder="Vị trí gần nhất">
                                                        <label for="LastPosition">Vị trí gần nhất</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="number" id="YearsOfExperience" name="YearsOfExperience" class="form-control" value="@cvDetail.YearsOfExperience" placeholder="Số năm kinh nghiệm" min="0" max="50">
                                                        <label for="YearsOfExperience">Số năm kinh nghiệm</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="number" id="ExpectedSalary" name="ExpectedSalary" class="form-control" value="@cvDetail.ExpectedSalary" placeholder="Mức lương mong muốn">
                                                        <label for="ExpectedSalary">Mức lương mong muốn (VNĐ)</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating mb-3">
                                                        <textarea id="WorkExperience" name="WorkExperience" class="form-control" placeholder="Mô tả kinh nghiệm làm việc" style="height: 100px">@cvDetail.WorkExperience</textarea>
                                                        <label for="WorkExperience">Mô tả kinh nghiệm làm việc</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0"><i class="bi bi-tools me-2"></i>Kỹ năng & Chứng chỉ</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="PreferredJobTitle" name="PreferredJobTitle" class="form-control" value="@cvDetail.PreferredJobTitle" placeholder="Vị trí mong muốn">
                                                        <label for="PreferredJobTitle">Vị trí mong muốn</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-floating mb-3">
                                                        <input type="text" id="Languages" name="Languages" class="form-control" value="@cvDetail.Languages" placeholder="Ngôn ngữ">
                                                        <label for="Languages">Ngôn ngữ (VD: Tiếng Anh, Tiếng Nhật)</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating mb-3">
                                                        <textarea id="Skills" name="Skills" class="form-control" placeholder="Kỹ năng" style="height: 100px">@cvDetail.Skills</textarea>
                                                        <label for="Skills">Kỹ năng (VD: Microsoft Office, Photoshop, Java)</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating mb-3">
                                                        <textarea id="Certificates" name="Certificates" class="form-control" placeholder="Chứng chỉ" style="height: 100px">@cvDetail.Certificates</textarea>
                                                        <label for="Certificates">Chứng chỉ (VD: TOEIC 700, AWS Certified)</label>
                                                    </div>
                                                </div>
                                                <div class="col-12">
                                                    <div class="form-floating mb-3">
                                                        <textarea id="AdditionalInfo" name="AdditionalInfo" class="form-control" placeholder="Thông tin bổ sung" style="height: 100px">@cvDetail.AdditionalInfo</textarea>
                                                        <label for="AdditionalInfo">Thông tin bổ sung</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-primary px-5 py-2">
                                            <i class="bi bi-save me-2"></i> Lưu thông tin CV
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Tab Đổi mật khẩu -->
                            <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                                <div class="alert alert-info rounded-3 mb-4">
                                    <div class="d-flex">
                                        <div class="flex-shrink-0">
                                            <i class="bi bi-info-circle-fill fs-4"></i>
                                        </div>
                                        <div class="ms-3">
                                            <h5 class="alert-heading">@(hasPassword ? "Đổi mật khẩu" : "Tạo mật khẩu")</h5>
                                            <p class="mb-0">@(hasPassword ? "Mật khẩu mới phải có ít nhất 6 ký tự." : "Hãy tạo mật khẩu để bảo vệ tài khoản của bạn.")</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <form asp-action="ChangePassword" method="post">
                                    <div class="row justify-content-center">
                                        <div class="col-lg-8">
                                            @if (hasPassword)
                                            {
                                                <div class="form-floating mb-4">
                                                    <input type="password" id="currentPassword" name="CurrentPassword" class="form-control" 
                                                           placeholder="Mật khẩu hiện tại" required />
                                                    <label for="currentPassword">Mật khẩu hiện tại</label>
                                                    <div class="password-toggle position-absolute top-50 end-0 translate-middle-y me-3">
                                                        <a href="javascript:void(0)" onclick="togglePassword('currentPassword', 'currentPasswordIcon')">
                                                            <i id="currentPasswordIcon" class="bi bi-eye-slash"></i>
                                                        </a>
                                                    </div>
                                                </div>
                                            }
                                            <div class="form-floating mb-4">
                                                <input type="password" id="newPassword" name="NewPassword" class="form-control" 
                                                       placeholder="@(hasPassword ? "Mật khẩu mới" : "Mật khẩu")" required minlength="6" />
                                                <label for="newPassword">@(hasPassword ? "Mật khẩu mới" : "Mật khẩu")</label>
                                                <div class="password-toggle position-absolute top-50 end-0 translate-middle-y me-3">
                                                    <a href="javascript:void(0)" onclick="togglePassword('newPassword', 'newPasswordIcon')">
                                                        <i id="newPasswordIcon" class="bi bi-eye-slash"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="form-floating mb-4">
                                                <input type="password" id="confirmNewPassword" name="ConfirmNewPassword" class="form-control" 
                                                       placeholder="Xác nhận mật khẩu" required minlength="6" />
                                                <label for="confirmNewPassword">Xác nhận mật khẩu</label>
                                                <div class="password-toggle position-absolute top-50 end-0 translate-middle-y me-3">
                                                    <a href="javascript:void(0)" onclick="togglePassword('confirmNewPassword', 'confirmNewPasswordIcon')">
                                                        <i id="confirmNewPasswordIcon" class="bi bi-eye-slash"></i>
                                                    </a>
                                                </div>
                                            </div>
                                            <div class="text-center mt-4">
                                                <button type="submit" class="btn btn-primary px-5 py-2">
                                                    <i class="bi bi-shield-lock-fill me-2"></i> @(hasPassword ? "Đổi mật khẩu" : "Tạo mật khẩu")
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Function to toggle password visibility
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === "password") {
                input.type = "text";
                icon.classList.replace("bi-eye-slash", "bi-eye");
            } else {
                input.type = "password";
                icon.classList.replace("bi-eye", "bi-eye-slash");
            }
        }
        
        // Auto-select tab based on hash in URL
        document.addEventListener('DOMContentLoaded', function() {
            const hash = window.location.hash;
            if (hash) {
                const tabId = hash.replace('#', '');
                const tab = document.querySelector(`#profileTabs button[data-bs-target="#${tabId}"]`);
                if (tab) {
                    const bsTab = new bootstrap.Tab(tab);
                    bsTab.show();
                }
            }
        });
    </script>
}
